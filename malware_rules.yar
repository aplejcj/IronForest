import "pe"

rule Suspicious_PE_Imports
{
    meta:
        description = "Detects suspicious imports often used by malware for process injection and manipulation."
        author = "IronForest"
        date = "2024-07-07"
    condition:
        uint16(0) == 0x5A4D and // MZ header for PE files
        (
            pe.imports("kernel32.dll", "CreateRemoteThread") or
            pe.imports("kernel32.dll", "WriteProcessMemory") or
            pe.imports("kernel32.dll", "VirtualAllocEx") or
            pe.imports("kernel32.dll", "LoadLibraryA")
        )
}

rule Packed_UPX
{
    meta:
        description = "Detects files packed with UPX packer."
        author = "IronForest"
        date = "2024-07-07"
    strings:
        $upx_sig1 = "UPX!"
        $upx_sig2 = { 55 50 58 30 } // UPX0
        $upx_sig3 = { 55 50 58 31 } // UPX1
    condition:
        any of them
}

rule PowerShell_Download_Execute
{
    meta:
        description = "Detects PowerShell scripts that download and execute code from the web."
        author = "IronForest"
        date = "2024-07-07"
    strings:
        $s1 = "System.Net.WebClient"
        $s2 = "DownloadString"
        $s3 = "DownloadFile"
        $s4 = "IEX"
        $s5 = "Invoke-Expression"
    condition:
        all of ($s1, ($s2 or $s3), ($s4 or $s5))
}

rule HighEntropySection
{
    meta:
        description = "Detects PE sections with high entropy, common in packed or encrypted malware."
        author = "IronForest"
        date = "2024-07-07"
    condition:
        uint16(0) == 0x5a4d and
        for any section in pe.sections : ( pe.entropy(section) > 7.5 )
}